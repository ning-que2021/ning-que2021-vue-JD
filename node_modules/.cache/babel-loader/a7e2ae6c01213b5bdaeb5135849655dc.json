{"ast":null,"code":"import Vue from 'vue';\nimport VueRouter from 'vue-router';\nimport routes from \"./routes\";\nimport store from \"../store\";\nVue.use(VueRouter); //重写push|replace 方法\n\nlet originPush = VueRouter.prototype.push;\n\nVueRouter.prototype.push = function (location, resolve, reject) {\n  if (resolve && reject) {\n    //call||apply区别\n    //相同点：都可以调用函数·篡改函数的上下文\n    //不同点：call传递参数要用，隔开  而apply传递参数要传递 数组[]\n    originPush.call(this, location, resolve, reject);\n  } else {\n    originPush.call(this, location, () => {}, () => {});\n  }\n}; //重写replace 方法\n\n\nlet originReplace = VueRouter.prototype.replace;\n\nVueRouter.prototype.replace = function (location, resolve, reject) {\n  if (resolve && reject) {\n    originReplace.call(this, location, resolve, reject);\n  } else {\n    originReplace.call(this, location, () => {}, () => {});\n  }\n};\n\nconst router = new VueRouter({\n  routes,\n\n  //跳转后滚动行为\n  scrollBehavior(to, from, savedPosition) {\n    return {\n      y: 0\n    };\n  }\n\n}); //全局守卫，前置守卫\n\nrouter.beforeEach(async (to, from, next) => {\n  //to可以获取到你要跳转到哪个路由的信息\n  //from：可以获取到你从哪个路由而来的信息\n  //next：放行函数   next() 全部放行; next（‘path’）放行到指定的路由\n  let token = store.state.user.token; //用户信息\n\n  let name = store.state.user.userInfo.name; //如果已经登录\n\n  if (token) {\n    //已经登录还想去login，不能去返回首页\n    if (to.path == '/login') {\n      next('/home');\n    } else {\n      //登录，去的不是login，而是其他路由组件页面\n      //如果用户名已经有了 放行\n      if (name) {\n        next();\n      } else {\n        //如果没有用户信息，派发action让仓库存储用户信息再跳转\n        //妙\n        try {\n          await store.dispatch('getUserInfo');\n          next();\n        } catch (error) {\n          //token失效了获取不到用户信息，重新登录\n          //清楚token\n          store.dispatch('userLogout');\n          next('/login');\n        }\n      }\n    }\n  } else {\n    //未登录：不能去交易相关、不能去支付相关【pay|paysuccess】、不能去个人中心\n    //未登录去上面这些路由-----登录\n    let toPath = to.path;\n\n    if (toPath.indexOf('/trade') != -1 || toPath.indexOf('/pay') != -1 || toPath.indexOf('/center') != -1) {\n      //把未登录的时候向去而没有去成的信息，存储于地址栏中【路由】\n      next('/login?redirect=' + toPath);\n    } else {\n      //去的不是上面这些路由（home|search|shopCart）---放行\n      next();\n    }\n  }\n});\nexport default router;","map":null,"metadata":{},"sourceType":"module"}